#!/usr/bin/env ruby

require "docopt"
require_relative "../lib/scanny"
include Scanny::CLI

doc = "Scanny RoR secutiry scanner

Usage:
  scanny [options] <files_or_dirs>...

Options:
  -h, --help                        Show this screen.
  -i <check>, --include <check>     Include check to scanning process (file or directory).
  -d <check>, --disable <check>     Disable check class from scanning process."

options = Docopt(doc)

runner  = runner_with_disabled_checks(options[:disable])
reports = []
issues  = 0

require_checks(options[:include])

build_paths.each do |arg|
  Dir[arg].each do |file|
    begin
      reports << runner.check_file(file)
    rescue SyntaxError => e
      $stderr.puts "Can't parse #{file} as Ruby file."
      exit 2
    end
  end
end

reports.each do |report|
  issues += report.issues.size
  puts report
end
puts

if issues == 0
  puts "Found no issues."
  exit 0
else
  puts "Found #{issues} issues."
  exit 1
end